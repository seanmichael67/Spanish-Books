<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Oso - Beibei Amigos</title>
    <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: 'Sour Gummy', cursive; }
        .page-fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce-slow { animation: bounce-slow 2s infinite ease-in-out; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* PDF Printing */
        @media print {
            .no-print { display: none !important; }
            .pdf-page { page-break-after: always !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /**
         * üìö BOOK CONFIGURATION - EDIT THIS FOR NEW BOOKS
         * -------------------------------------------------------------
         */
        const BOOK_CONFIG = {
            title: "El Oso",
            subtitle: "The Bear",
            weekNumber: 1,
            theme: "Animals / Animales",
            schoolName: "Beibei Amigos Language Preschool",
            websiteUrl: "https://www.beibeiamigos.com",
            logoUrl: "https://www.beibeiamigos.com/wp-content/uploads/2025/12/ChatGPT-Image-Aug-18-2025-05_26_03-PM.png",
            apiKey: "AIzaSyAgRLqmj0g6VDtdnEZNT0USuQTV2xVxWUc",
            
            // EXACTLY 8 PAGES
            pages: [
                // Page 1: Title
                {
                    type: "title",
                    spanish: "El Oso",
                    english: "The Bear",
                    imageUrl: "https://images.unsplash.com/photo-1589656966895-2f33e7653819?w=800" // Bear portrait
                },
                
                // Pages 2-7: Content (6 pages)
                {
                    type: "content",
                    spanish: "El oso es grande.",
                    english: "The bear is big.",
                    imageUrl: "https://images.unsplash.com/photo-1530595467537-0b5996c41f2d?w=800", // Big bear
                    imagePrompt: "Professional wildlife photograph of a large brown bear standing tall in natural habitat, realistic nature photography, natural lighting"
                },
                {
                    type: "content",
                    spanish: "El oso es caf√©.",
                    english: "The bear is brown.",
                    imageUrl: "https://images.unsplash.com/photo-1589656966895-2f33e7653819?w=800", // Brown bear
                    imagePrompt: "Professional wildlife photograph of a brown bear close-up showing brown fur, realistic nature photography, natural lighting"
                },
                {
                    type: "content",
                    spanish: "El oso es fuerte.",
                    english: "The bear is strong.",
                    imageUrl: "https://images.unsplash.com/photo-1564349683136-77e08dba1ef7?w=800", // Strong bear
                    imagePrompt: "Professional wildlife photograph of a muscular brown bear showing strength, realistic nature photography, natural lighting"
                },
                {
                    type: "content",
                    spanish: "El oso camina.",
                    english: "The bear walks.",
                    imageUrl: "https://images.unsplash.com/photo-1589656966895-2f33e7653819?w=800", // Bear walking
                    imagePrompt: "Professional wildlife photograph of a brown bear walking through forest, realistic nature photography, natural lighting"
                },
                {
                    type: "content",
                    spanish: "El oso est√° en el bosque.",
                    english: "The bear is in the forest.",
                    imageUrl: "https://images.unsplash.com/photo-1589656966895-2f33e7653819?w=800", // Bear in forest
                    imagePrompt: "Professional wildlife photograph of a brown bear in a forest setting with trees, realistic nature photography, natural lighting"
                },
                {
                    type: "content",
                    spanish: "¬°El oso!",
                    english: "The bear!",
                    imageUrl: "https://images.unsplash.com/photo-1530595467537-0b5996c41f2d?w=800", // Bear close-up
                    imagePrompt: "Professional wildlife photograph of a brown bear face close-up, realistic nature photography, natural lighting"
                },
                
                // Page 8: The End
                {
                    type: "end",
                    spanish: "Fin",
                    english: "The End",
                    imageUrl: "https://images.unsplash.com/photo-1589656966895-2f33e7653819?w=800" // Happy bear
                }
            ]
        };

        // UI Icons (same as original)
        const ChevronLeft = ({ size = 24, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>);
        const ChevronRight = ({ size = 24, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>);
        const Loader2 = ({ size = 24, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>);
        const FileDown = ({ size = 24, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>);
        const Volume2 = ({ size = 24, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>);
        const PlayCircle = ({ size = 24, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>);
        const Square = ({ size = 24, className, fill }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill={fill}/></svg>);
        const RotateCcw = ({ size = 24, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>);

        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmData.length, true);
            new Uint8Array(buffer, 44).set(pcmData);
            return new Blob([buffer], { type: 'audio/wav' });
        };

        const App = () => {
            const [currentPage, setCurrentPage] = useState(0);
            const [audioCache, setAudioCache] = useState({});
            const [isReading, setIsReading] = useState(false);
            const [isAutoAdvancing, setIsAutoAdvancing] = useState(false);
            const [activeWordIndex, setActiveWordIndex] = useState(-1);
            const [generatingPdf, setGeneratingPdf] = useState(false);
            const [readingSpeed, setReadingSpeed] = useState(0.8); // Slow for preschoolers

            const currentPageRef = useRef(0);
            const isAutoAdvancingRef = useRef(false);
            const audioRef = useRef(null);
            const syncRef = useRef(null);
            const printRef = useRef(null);

            useEffect(() => { currentPageRef.current = currentPage; }, [currentPage]);
            useEffect(() => { isAutoAdvancingRef.current = isAutoAdvancing; }, [isAutoAdvancing]);

            const fetchWithRetry = async (url, options, retries = 3) => {
                const effectiveKey = BOOK_CONFIG.apiKey;
                const urlWithKey = `${url}${url.includes('?') ? '&' : '?'}key=${effectiveKey}`;
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(urlWithKey, options);
                        if (!response.ok) throw new Error();
                        return await response.json();
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                    }
                }
            };

            const prefetchAudio = async (index) => {
                if (audioCache[index]) return audioCache[index];
                const page = BOOK_CONFIG.pages[index];
                const text = page.type === 'title' ? page.spanish : 
                             page.type === 'end' ? page.spanish : 
                             page.spanish;
                
                try {
                    const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Read in clear, slow Spanish for preschoolers: ${text}` }] }],
                            generationConfig: { 
                                responseModalities: ["AUDIO"], 
                                speechConfig: { 
                                    voiceConfig: { 
                                        prebuiltVoiceConfig: { voiceName: "Leda" } 
                                    } 
                                } 
                            }
                        })
                    });
                    const inlineData = data.candidates[0].content.parts[0].inlineData;
                    const pcm = Uint8Array.from(atob(inlineData.data), c => c.charCodeAt(0));
                    const sampleRate = parseInt(inlineData.mimeType.split('rate=')[1]) || 24000;
                    const url = URL.createObjectURL(pcmToWav(pcm, sampleRate));
                    setAudioCache(prev => ({ ...prev, [index]: url }));
                    return url;
                } catch (e) { 
                    console.error("Audio generation failed", e); 
                    return null; 
                }
            };

            const readPage = async (auto = false, indexOverride = null) => {
                if (isReading && indexOverride === null) { stop(); return; }
                const indexToRead = indexOverride !== null ? indexOverride : currentPageRef.current;
                
                if (auto) {
                    setIsAutoAdvancing(true);
                    isAutoAdvancingRef.current = true;
                }

                setIsReading(true);
                const url = await prefetchAudio(indexToRead);
                
                if (!url || (!isAutoAdvancingRef.current && auto)) {
                    setIsReading(false);
                    return;
                }

                const audio = new Audio(url);
                audio.playbackRate = readingSpeed;
                audioRef.current = audio;
                
                const page = BOOK_CONFIG.pages[indexToRead];
                const words = page.spanish.split(/\s+/);
                
                audio.onplay = () => {
                    const update = () => {
                        if (audioRef.current === audio && !audio.paused && !audio.ended) {
                            const progress = audio.currentTime / audio.duration;
                            const wordIdx = Math.floor(progress * words.length);
                            setActiveWordIndex(wordIdx);
                            syncRef.current = requestAnimationFrame(update);
                        }
                    };
                    update();
                };
                
                audio.onended = () => {
                    setIsReading(false); 
                    setActiveWordIndex(-1);
                    if (isAutoAdvancingRef.current) {
                        if (indexToRead < BOOK_CONFIG.pages.length - 1) {
                            setTimeout(() => goToPage(indexToRead + 1, true), 1500);
                        } else {
                            setTimeout(() => { stop(); goToPage(0, false); }, 2000);
                        }
                    }
                };
                audio.play().catch(() => setIsReading(false));
            };

            const stop = () => { 
                if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
                setIsReading(false); 
                setIsAutoAdvancing(false); 
                isAutoAdvancingRef.current = false;
                setActiveWordIndex(-1); 
                if (syncRef.current) cancelAnimationFrame(syncRef.current);
            };

            const goToPage = (idx, autoChain = false) => {
                if (!autoChain) stop();
                setCurrentPage(idx);
                if (autoChain && isAutoAdvancingRef.current) {
                    setTimeout(() => readPage(false, idx), 500); 
                }
            };

            const handleDownloadPdf = async () => {
                if (generatingPdf) return;
                setGeneratingPdf(true);
                setTimeout(async () => {
                    if (typeof html2pdf === 'undefined') {
                        setGeneratingPdf(false);
                        return;
                    }
                    const element = printRef.current;
                    const opt = {
                        margin: [0.5, 0.5],
                        filename: `${BOOK_CONFIG.title.replace(/\s+/g, '_')}_Week_${BOOK_CONFIG.weekNumber}.pdf`,
                        image: { type: 'jpeg', quality: 0.95 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                        pagebreak: { mode: ['avoid-all', 'css'] }
                    };
                    try { await html2pdf().set(opt).from(element).save(); } 
                    finally { setGeneratingPdf(false); }
                }, 300);
            };

            const HighlightedText = ({ text }) => {
                const words = text.split(/\s+/);
                return (
                    <span>
                        {words.map((w, i) => (
                            <span key={i} className={`inline-block transition-all duration-300 px-2 py-1 mx-1 rounded-lg ${activeWordIndex === i ? 'bg-yellow-300 scale-125 font-extrabold shadow-lg transform -translate-y-1' : ''}`}>
                                {w}
                            </span>
                        ))}
                    </span>
                );
            };

            const Page = ({ idx }) => {
                const page = BOOK_CONFIG.pages[idx];
                
                if (page.type === 'title') {
                    return (
                        <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-indigo-600 to-purple-600 text-white p-12">
                            <h1 className="text-7xl font-bold mb-4">{page.spanish}</h1>
                            <p className="text-3xl opacity-90 mb-8">{page.english}</p>
                            <img src={page.imageUrl} alt={page.spanish} className="max-w-md rounded-2xl shadow-2xl mt-8" />
                            <div className="mt-12 flex items-center gap-3">
                                <img src={BOOK_CONFIG.logoUrl} className="h-12" />
                                <div className="text-left">
                                    <p className="text-sm font-bold">{BOOK_CONFIG.schoolName}</p>
                                    <p className="text-xs opacity-75">Week {BOOK_CONFIG.weekNumber} ‚Ä¢ {BOOK_CONFIG.theme}</p>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                if (page.type === 'end') {
                    return (
                        <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-green-500 to-teal-500 text-white p-12">
                            <h1 className="text-7xl font-bold mb-4">{page.spanish}</h1>
                            <p className="text-3xl opacity-90 mb-8">{page.english}</p>
                            <div className="text-6xl mb-8">üåü ‚≠ê üåü</div>
                            <p className="text-2xl font-bold">¬°Buen trabajo!</p>
                            <p className="text-xl opacity-90">Great job!</p>
                            <button onClick={() => goToPage(0)} className="mt-12 px-8 py-4 bg-white text-teal-600 rounded-2xl font-bold text-lg hover:scale-110 transition shadow-xl flex items-center gap-2">
                                <RotateCcw size={24} /> Read Again
                            </button>
                        </div>
                    );
                }

                return (
                    <div className="flex flex-col items-center justify-between h-full bg-white p-12">
                        <div className="flex-1 flex items-center justify-center w-full">
                            <img src={page.imageUrl} alt={page.spanish} className="max-h-[60vh] w-full object-contain rounded-2xl shadow-2xl" />
                        </div>
                        <div className="text-center space-y-6 w-full mt-8">
                            <div className="text-5xl font-bold text-gray-900 leading-tight">
                                <HighlightedText text={page.spanish} />
                            </div>
                            <p className="text-2xl text-gray-500 italic">{page.english}</p>
                            <div className="flex justify-center gap-4 mt-6">
                                <button onClick={() => readPage(false)} className={`p-4 rounded-full shadow-xl transition-all ${isReading ? 'bg-blue-100 text-blue-400' : 'bg-blue-600 text-white hover:scale-110 active:scale-95'}`}>
                                    {isReading ? <Loader2 size={32} /> : <Volume2 size={32} />}
                                </button>
                            </div>
                            <div className="pt-6 border-t flex justify-between text-xs text-gray-400 font-bold">
                                <span>BEIBEI AMIGOS</span>
                                <span>P√ÅGINA {idx + 1} de {BOOK_CONFIG.pages.length}</span>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white/95 backdrop-blur p-4 sticky top-0 z-50 flex justify-between items-center px-8 shadow-lg no-print">
                        <div className="flex items-center gap-3">
                            <img src={BOOK_CONFIG.logoUrl} className="h-12" />
                            <div>
                                <h1 className="text-xl font-bold">{BOOK_CONFIG.title}</h1>
                                <p className="text-xs text-gray-500">Week {BOOK_CONFIG.weekNumber} ‚Ä¢ {BOOK_CONFIG.theme}</p>
                            </div>
                        </div>
                        <div className="flex gap-3 items-center">
                            <select value={readingSpeed} onChange={(e) => setReadingSpeed(parseFloat(e.target.value))} className="px-4 py-2 rounded-lg border-2 border-gray-200 text-sm font-bold">
                                <option value="0.6">Muy Lento</option>
                                <option value="0.8">Lento</option>
                                <option value="1.0">Normal</option>
                            </select>
                            <button onClick={() => readPage(true)} className={`px-6 py-3 rounded-xl text-sm font-bold transition shadow-lg ${isAutoAdvancing ? "bg-red-500 text-white" : "bg-indigo-600 text-white hover:bg-indigo-700"}`}>
                                {isAutoAdvancing ? <><Square size={16} fill="white" className="inline mr-2"/> Stop</> : <><PlayCircle size={16} className="inline mr-2"/> Read All</>}
                            </button>
                            <button onClick={handleDownloadPdf} disabled={generatingPdf} className="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 transition shadow-lg disabled:bg-blue-300">
                                {generatingPdf ? <Loader2 size={16} /> : <FileDown size={16} />} 
                                {generatingPdf ? "Generating..." : "PDF"}
                            </button>
                        </div>
                    </header>
                    
                    <main className="flex-1 flex flex-col items-center justify-center p-8">
                        <div className="w-full max-w-5xl">
                            <div className="bg-white rounded-3xl shadow-2xl overflow-hidden h-[85vh] page-fade-in">
                                <Page idx={currentPage} />
                            </div>
                            
                            <div className="flex items-center justify-center gap-6 mt-8 no-print">
                                <button onClick={() => goToPage(currentPage - 1)} disabled={currentPage === 0} className="p-4 bg-white rounded-full shadow-xl disabled:opacity-30 hover:scale-110 transition">
                                    <ChevronLeft size={32} />
                                </button>
                                
                                <div className="flex gap-2">
                                    {BOOK_CONFIG.pages.map((_, i) => (
                                        <button key={i} onClick={() => goToPage(i)} className={`h-3 rounded-full transition-all ${i === currentPage ? "bg-blue-600 w-12" : "bg-gray-300 w-3 hover:w-6"}`} />
                                    ))}
                                </div>
                                
                                <button onClick={() => goToPage(currentPage + 1)} disabled={currentPage === BOOK_CONFIG.pages.length - 1} className="p-4 bg-white rounded-full shadow-xl disabled:opacity-30 hover:scale-110 transition">
                                    <ChevronRight size={32} />
                                </button>
                            </div>
                        </div>
                    </main>

                    {/* Hidden PDF Print Layout */}
                    <div ref={printRef} className="hidden">
                        {BOOK_CONFIG.pages.map((_, i) => (
                            <div key={i} className="pdf-page">
                                <Page idx={i} />
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>