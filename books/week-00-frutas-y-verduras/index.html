<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beibei Amigos - Mis Frutas Y Verduras</title>
    <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="../../config.js"></script>
    <style>
        body { font-family: 'Sour Gummy', cursive; }
        .perspective-2000 { perspective: 2000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .page-flip-next { animation: flipNext 0.6s ease-in-out forwards; }
        .page-flip-prev { animation: flipPrev 0.6s ease-in-out forwards; }
        @keyframes flipNext { 0% { transform: rotateY(0deg); opacity: 1; } 100% { transform: rotateY(-90deg); opacity: 0; } }
        @keyframes flipPrev { 0% { transform: rotateY(0deg); opacity: 1; } 100% { transform: rotateY(90deg); opacity: 0; } }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        @media print { .no-print { display: none !important; } .pdf-page { page-break-after: always !important; break-after: page !important; } }
    </style>
</head>
<body class="bg-slate-100 antialiased overflow-x-hidden">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const apiKey = typeof GEMINI_API_KEY !== 'undefined' ? GEMINI_API_KEY : "";

        const BOOK_CONFIG = {
            title: "Mis Frutas y Verduras",
            schoolName: "Beibei Amigos Language Preschool",
            websiteUrl: "https://www.beibeiamigos.com",
            logoUrl: "https://www.beibeiamigos.com/wp-content/uploads/2025/12/ChatGPT-Image-Aug-18-2025-05_26_03-PM.png",
            pages: [
                { title: "Mis Frutas y Verduras", footer: "Aprendiendo juntos", prompt: "A beautiful arrangement of fresh organic fruits and vegetables: a red apple, yellow banana, green pear, and orange carrot. Isolated on pure white background, studio lighting, high resolution." },
                { title: "La Manzana", footer: "La manzana es roja.", prompt: "A single crisp red gala apple with a small green leaf, isolated on pure white background, studio lighting." },
                { title: "El Plátano", footer: "El plátano es amarillo.", prompt: "One perfectly ripe yellow banana, isolated on pure white background, studio lighting." },
                { title: "La Pera", footer: "La pera es verde.", prompt: "A single fresh green pear, isolated on pure white background, studio lighting." },
                { title: "La Zanahoria", footer: "La zanahoria es naranja.", prompt: "A bright orange carrot with green leafy tops, isolated on pure white background, studio lighting." },
                { title: "El Brócoli", footer: "El brócoli es verde.", prompt: "A fresh head of green broccoli, isolated on pure white background, studio lighting." },
                { title: "El Tomate", footer: "El tomate es rojo.", prompt: "A round shiny red tomato with a small green stem, isolated on pure white background, studio lighting." },
                { title: "¡Buen trabajo!", footer: "Colorea tu fruta favorita", prompt: "A happy golden star wearing a small crown, surrounded by colorful berries, isolated on pure white background." }
            ]
        };

        const Icons = {
            ChevronLeft: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Loader: ({ size = 24, className }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Download: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Volume: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
            Play: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>,
            Stop: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="currentColor"/></svg>
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + pcmData.length, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, pcmData.length, true); new Uint8Array(buffer, 44).set(pcmData);
            return new Blob([buffer], { type: 'audio/wav' });
        };

        const App = () => {
            const [viewMode, setViewMode] = useState('preview');
            const [currentPage, setCurrentPage] = useState(0);
            const [images, setImages] = useState({});
            const [audioCache, setAudioCache] = useState({});
            const [isReading, setIsReading] = useState(false);
            const [isAutoAdvancing, setIsAutoAdvancing] = useState(false);
            const [isAnimating, setIsAnimating] = useState(false);
            const [direction, setDirection] = useState('next');
            const [activeWordIndex, setActiveWordIndex] = useState(-1);
            const [generatingPdf, setGeneratingPdf] = useState(false);
            const audioRef = useRef(null);
            const syncRef = useRef(null);
            const printRef = useRef(null);
            const fetchPromisesRef = useRef({});

            useEffect(() => {
                const CACHE_KEY = `book-images-${BOOK_CONFIG.title}`;
                const loadImages = async () => {
                    // Try localStorage cache first
                    try {
                        const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
                        if (cached && Object.keys(cached).length === BOOK_CONFIG.pages.length) {
                            setImages(cached);
                            return;
                        }
                    } catch(e) {}

                    // Generate ALL images in parallel
                    const promises = BOOK_CONFIG.pages.map(async (page, i) => {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                        const payload = { instances: { prompt: page.prompt }, parameters: { sampleCount: 1 } };
                        try {
                            const response = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                            const data = await response.json();
                            if (data.predictions?.[0]) {
                                const img = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                                setImages(prev => ({ ...prev, [i]: img }));
                                return [i, img];
                            }
                        } catch (e) { console.error(`Image ${i} failed`, e); }
                        return null;
                    });

                    const results = await Promise.all(promises);
                    // Cache all images to localStorage
                    const allImages = {};
                    results.forEach(r => { if (r) allImages[r[0]] = r[1]; });
                    try { localStorage.setItem(CACHE_KEY, JSON.stringify(allImages)); } catch(e) {}
                };
                loadImages();
            }, []);

            const prefetchAudio = async (index) => {
                if (audioCache[index]) return audioCache[index];
                if (fetchPromisesRef.current[index]) return fetchPromisesRef.current[index];
                fetchPromisesRef.current[index] = (async () => {
                    const text = `${BOOK_CONFIG.pages[index].title}. ${BOOK_CONFIG.pages[index].footer}`;
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: `Read standard neutral Spanish clearly: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Leda" } } } }, model: "gemini-2.5-flash-preview-tts" })
                        });
                        const data = await response.json();
                        const inlineData = data.candidates[0].content.parts[0].inlineData;
                        const pcm = Uint8Array.from(atob(inlineData.data), c => c.charCodeAt(0));
                        const sampleRate = parseInt(inlineData.mimeType.split('rate=')[1]) || 24000;
                        const url = URL.createObjectURL(pcmToWav(pcm, sampleRate));
                        setAudioCache(prev => ({ ...prev, [index]: url }));
                        return url;
                    } catch (e) { delete fetchPromisesRef.current[index]; return null; }
                })();
                return fetchPromisesRef.current[index];
            };

            const readPage = async (auto = false, overrideIdx = null) => {
                const idx = overrideIdx !== null ? overrideIdx : currentPage;
                if (isReading && overrideIdx === null) { stopReading(); return; }
                setIsReading(true);
                if (auto) setIsAutoAdvancing(true);
                const url = await prefetchAudio(idx);
                if (!url) { setIsReading(false); return; }
                const audio = new Audio(url);
                audio.volume = 0.8;
                audioRef.current = audio;
                const fullText = `${BOOK_CONFIG.pages[idx].title}. ${BOOK_CONFIG.pages[idx].footer}`;
                const words = fullText.replace(/\. /g, ' . ').split(/\s+/);
                audio.onplay = () => {
                    const update = () => {
                        if (audioRef.current === audio && !audio.paused && !audio.ended) {
                            const wordIdx = Math.floor((audio.currentTime / audio.duration) * words.length);
                            const currentWord = words[wordIdx];
                            if (currentWord !== '.') {
                                const activeCount = words.slice(0, wordIdx).filter(w => w !== '.').length;
                                setActiveWordIndex(activeCount);
                            }
                            syncRef.current = requestAnimationFrame(update);
                        }
                    };
                    update();
                };
                audio.onended = () => {
                    setIsReading(false); setActiveWordIndex(-1);
                    if (auto || isAutoAdvancing) {
                        if (idx < BOOK_CONFIG.pages.length - 1) { setTimeout(() => nav(idx + 1, 'next', true), 1000); }
                        else { setIsAutoAdvancing(false); }
                    }
                };
                audio.play().catch(() => setIsReading(false));
            };

            const stopReading = () => {
                if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
                setIsReading(false); setIsAutoAdvancing(false); setActiveWordIndex(-1);
                if (syncRef.current) cancelAnimationFrame(syncRef.current);
            };

            const nav = (idx, dir, fromAuto = false) => {
                if (isAnimating && !fromAuto) return;
                if (!fromAuto) stopReading();
                setDirection(dir); setIsAnimating(true);
                setTimeout(() => { setCurrentPage(idx); setIsAnimating(false);
                    if (fromAuto) { setTimeout(() => readPage(true, idx), 500); }
                }, 600);
            };

            const handleDownloadPdf = async () => {
                setGeneratingPdf(true); const originalMode = viewMode; setViewMode('print');
                setTimeout(async () => {
                    const element = printRef.current;
                    const opt = { margin: 0, filename: 'Mis_Frutas_Y_Verduras_Beibei.pdf', image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' },
                        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };
                    try { await html2pdf().set(opt).from(element).save(); } finally { setGeneratingPdf(false); setViewMode(originalMode); }
                }, 1000);
            };

            const HighlightedText = ({ text, start = 0 }) => {
                const words = text.split(/\s+/);
                return words.map((w, i) => (
                    <span key={i} className={`inline-block transition-all px-1 rounded ${activeWordIndex === (start + i) ? 'bg-yellow-300 scale-110' : ''}`}>{w}{' '}</span>
                ));
            };

            const PageUI = ({ idx, isPrint = false }) => {
                const data = BOOK_CONFIG.pages[idx];
                if (!data) return <div className="w-full h-full bg-white border border-gray-100" />;
                const titleCount = data.title.split(/\s+/).length;
                return (
                    <div className={`relative flex flex-col items-center justify-between bg-white ${isPrint ? 'w-[5.5in] h-[8.5in] p-10' : 'w-full h-full p-6 md:p-10 shadow-inner border-l-4 border-gray-100 overflow-hidden'}`}>
                        <div className="text-center w-full flex-shrink-0">
                            <h2 className="text-3xl md:text-5xl font-bold text-gray-800 mb-2 leading-tight">
                                {isPrint ? data.title : <HighlightedText text={data.title} start={0} />}
                            </h2>
                            {idx === 0 && (
                                <div className="flex items-center justify-center gap-2 mt-1">
                                    <img src={BOOK_CONFIG.logoUrl} className="h-4 md:h-6 object-contain" />
                                    <span className="text-blue-600 text-[8px] md:text-[10px] font-bold uppercase tracking-widest">{BOOK_CONFIG.schoolName}</span>
                                </div>
                            )}
                        </div>
                        <div className="flex-1 flex items-center justify-center w-full my-2 md:my-4 min-h-0">
                            {images[idx] ? (
                                <img src={images[idx]} className="max-h-full max-w-full object-contain drop-shadow-xl" />
                            ) : (
                                <div className="flex flex-col items-center gap-2">
                                    <Icons.Loader size={32} className="text-blue-200" />
                                    <span className="text-[8px] uppercase tracking-tighter text-blue-300 animate-pulse">Generando...</span>
                                </div>
                            )}
                        </div>
                        <div className="w-full text-center space-y-2 md:space-y-4 flex-shrink-0">
                            <div className="flex items-center justify-center gap-3">
                                <p className="text-xl md:text-3xl font-bold text-gray-700">
                                    {isPrint ? data.footer : <HighlightedText text={data.footer} start={titleCount} />}
                                </p>
                                {!isPrint && (
                                    <button onClick={() => readPage(false)} className={`p-2 md:p-3 rounded-full shadow-lg transition flex-shrink-0 ${isReading ? 'bg-blue-100 text-blue-400' : 'bg-blue-600 text-white hover:scale-105 active:scale-95'}`}>
                                        <Icons.Volume size={18} />
                                    </button>
                                )}
                            </div>
                            <div className="pt-2 md:pt-4 border-t border-gray-100 flex justify-between text-[8px] md:text-[10px] uppercase font-bold text-gray-300">
                                <span>Lectura Temprana</span><span>Página {idx + 1}</span>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col text-slate-900 overflow-hidden">
                    <header className="bg-white p-4 sticky top-0 z-50 flex flex-wrap justify-between items-center px-4 md:px-8 shadow-sm border-b gap-4">
                        <div className="flex items-center gap-3">
                            <img src={BOOK_CONFIG.logoUrl} className="h-8 w-8 md:h-10 md:w-10 object-contain rounded-full bg-slate-50 p-1" />
                            <div>
                                <h1 className="font-black text-sm md:text-xl leading-none">{BOOK_CONFIG.title}</h1>
                                <p className="text-[8px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest">{BOOK_CONFIG.schoolName}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 md:gap-4">
                            <div className="bg-slate-100 p-1 rounded-xl flex gap-1">
                                <button onClick={() => setViewMode('preview')} className={`px-2 md:px-4 py-1.5 md:py-2 rounded-lg text-[10px] md:text-xs font-bold transition ${viewMode === 'preview' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}>Libro</button>
                                <button onClick={() => setViewMode('print')} className={`px-2 md:px-4 py-1.5 md:py-2 rounded-lg text-[10px] md:text-xs font-bold transition ${viewMode === 'print' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}>Imprimir</button>
                            </div>
                            <button onClick={() => readPage(true)} className={`flex items-center gap-2 px-3 md:px-5 py-1.5 md:py-2.5 rounded-xl text-[10px] md:text-xs font-bold transition shadow-md ${isAutoAdvancing ? "bg-red-500 text-white" : "bg-indigo-600 text-white hover:bg-indigo-700"}`}>
                                {isAutoAdvancing ? <Icons.Stop size={12} /> : <Icons.Play size={12} />}
                                <span className="hidden sm:inline">{isAutoAdvancing ? "Detener" : "Leer Todo"}</span>
                            </button>
                            <button onClick={handleDownloadPdf} disabled={generatingPdf} className="flex items-center gap-2 px-3 md:px-6 py-1.5 md:py-2.5 bg-emerald-600 text-white rounded-xl text-[10px] md:text-xs font-bold hover:bg-emerald-700 transition shadow-md disabled:opacity-50">
                                {generatingPdf ? <Icons.Loader size={12} /> : <Icons.Download size={12} />}
                                <span className="hidden sm:inline">{generatingPdf ? "Generando..." : "Bajar PDF"}</span>
                            </button>
                        </div>
                    </header>
                    <main className="flex-1 flex flex-col items-center justify-center p-4 md:py-6 overflow-hidden">
                        {viewMode === 'preview' ? (
                            <div className="w-full max-w-5xl flex flex-col items-center gap-4 md:gap-8 h-full max-h-[calc(100vh-160px)]">
                                <div className="flex items-center gap-2 md:gap-8 w-full justify-center flex-1 min-h-0">
                                    <button onClick={() => nav(currentPage - 1, 'prev')} disabled={currentPage === 0 || isAnimating} className="p-2 md:p-4 bg-white rounded-full shadow-lg disabled:opacity-20 transition hover:scale-110 active:scale-90 flex-shrink-0"><Icons.ChevronLeft size={24} /></button>
                                    <div className="perspective-2000 w-full h-full max-w-3xl bg-white shadow-2xl rounded-2xl overflow-hidden relative border border-slate-200 flex flex-col">
                                        <div className={`w-full h-full transform-style-3d ${isAnimating ? (direction === 'next' ? 'page-flip-next' : 'page-flip-prev') : ''}`}>
                                            <PageUI idx={currentPage} />
                                        </div>
                                    </div>
                                    <button onClick={() => nav(currentPage + 1, 'next')} disabled={currentPage === BOOK_CONFIG.pages.length - 1 || isAnimating} className="p-2 md:p-4 bg-white rounded-full shadow-lg disabled:opacity-20 transition hover:scale-110 active:scale-90 flex-shrink-0"><Icons.ChevronRight size={24} /></button>
                                </div>
                                <div className="flex gap-2 flex-shrink-0">
                                    {BOOK_CONFIG.pages.map((_, i) => (<div key={i} className={`h-1.5 md:h-2.5 rounded-full transition-all duration-300 ${i === currentPage ? "bg-indigo-500 w-6 md:w-8" : "bg-slate-200 w-1.5 md:w-2.5"}`} />))}
                                </div>
                            </div>
                        ) : (
                            <div ref={printRef} className="flex flex-col items-center gap-12 bg-slate-200 p-6 md:p-12 rounded-3xl shadow-inner border border-slate-300 overflow-y-auto max-h-full">
                                {[[7,0],[1,6],[5,2],[3,4]].map(([leftIdx, rightIdx], spreadIdx) => (
                                    <div key={spreadIdx} className="flex bg-white shadow-2xl rounded-sm overflow-hidden pdf-page flex-shrink-0" style={{ width: '11in', height: '8.5in' }}>
                                        <PageUI idx={leftIdx} isPrint /><div className="w-px bg-slate-100 h-full relative"><div className="absolute top-0 bottom-0 left-[-1px] right-[-1px] border-l border-dashed border-slate-200" /></div><PageUI idx={rightIdx} isPrint />
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                    <footer className="py-4 text-center text-slate-400 text-[8px] md:text-[10px] font-bold uppercase tracking-[0.2em] flex-shrink-0">&copy; 2025 Beibei Amigos Interactive Literacy Project</footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
