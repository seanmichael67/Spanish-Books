<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Almuerzo - Learn Spanish for Preschoolers | Beibei Amigos</title>
    <meta name="description" content="Learn lunch vocabulary in Spanish with audio pronunciation. Ages 2-5.">
    <meta name="keywords" content="learn Spanish preschool, Spanish food book, lunch Spanish, bilingual children books">
    <meta property="og:title" content="El Almuerzo - Learn Spanish | Beibei Amigos">
    <meta property="og:description" content="Free interactive Spanish book for preschoolers. Learn lunch vocabulary in Spanish with audio pronunciation. Ages 2-5.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://spanish-books.onrender.com/books/week-10-el-almuerzo/">
    <meta property="og:image" content="https://www.beibeiamigos.com/wp-content/uploads/2025/12/ChatGPT-Image-Aug-18-2025-05_26_03-PM.png">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="canonical" href="https://spanish-books.onrender.com/books/week-10-el-almuerzo/">
    <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="../../config.js"></script>
    <style>
        body { font-family: 'Sour Gummy', cursive; }
        .perspective-2000 { perspective: 2000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .page-flip-next { animation: flipNext 0.6s ease-in-out forwards; }
        .page-flip-prev { animation: flipPrev 0.6s ease-in-out forwards; }
        @keyframes flipNext { 0% { transform: rotateY(0deg); opacity: 1; } 100% { transform: rotateY(-90deg); opacity: 0; } }
        @keyframes flipPrev { 0% { transform: rotateY(0deg); opacity: 1; } 100% { transform: rotateY(90deg); opacity: 0; } }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        /* Mobile: full screen book experience */
        @media (max-width: 768px) {
            header { padding: 8px 12px !important; }
            main { padding: 8px !important; }
            footer { padding: 4px !important; }
        }
        /* Tablet: nice reading size */
        @media (min-width: 769px) and (max-width: 1024px) {
            main { padding: 16px !important; }
        }
        @media print { .no-print { display: none !important; } .pdf-page { page-break-after: always !important; break-after: page !important; } }
    </style>
</head>
<body class="bg-slate-100 antialiased overflow-x-hidden">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const apiKey = typeof GEMINI_API_KEY !== 'undefined' ? GEMINI_API_KEY : "";

        const BOOK_CONFIG = {
            slug: "week-10-el-almuerzo",
            title: "El Almuerzo",
            schoolName: "Beibei Amigos Language Preschool",
            websiteUrl: "https://www.beibeiamigos.com",
            logoUrl: "https://www.beibeiamigos.com/wp-content/uploads/2025/12/ChatGPT-Image-Aug-18-2025-05_26_03-PM.png",
            pages: [
                {
                                "title": "El Almuerzo",
                                "footer": "Aprendiendo juntos",
                                "prompt": "A colorful lunch spread on a table with sandwich, soup, salad, and juice, bright daylight, professional food photography, landscape orientation, wide 16:9 format, high resolution."
                },
                {
                                "title": "El s√°ndwich es grande.",
                                "footer": "The sandwich is big.",
                                "prompt": "A large colorful sandwich with lettuce tomato cheese on a plate, professional food photography, landscape orientation, wide 16:9 format, high resolution."
                },
                {
                                "title": "La sopa es caliente.",
                                "footer": "The soup is hot.",
                                "prompt": "A bowl of warm vegetable soup with steam rising, colorful vegetables visible, professional food photography, landscape orientation, wide 16:9 format, high resolution."
                },
                {
                                "title": "La ensalada es verde.",
                                "footer": "The salad is green.",
                                "prompt": "A fresh vibrant green salad with tomatoes and carrots in a bowl, professional food photography, landscape orientation, wide 16:9 format, high resolution."
                },
                {
                                "title": "El arroz es blanco.",
                                "footer": "The rice is white.",
                                "prompt": "A plate of fluffy white rice with colorful vegetables on the side, professional food photography, landscape orientation, wide 16:9 format, high resolution."
                },
                {
                                "title": "El pollo es sabroso.",
                                "footer": "The chicken is tasty.",
                                "prompt": "Grilled chicken pieces on a colorful plate with vegetables, appetizing presentation, professional food photography, landscape orientation, wide 16:9 format, high resolution."
                },
                {
                                "title": "¬°El almuerzo!",
                                "footer": "Lunch!",
                                "prompt": "A beautiful complete lunch spread seen from above on a table, colorful and appetizing, professional food photography, landscape orientation, wide 16:9 format, high resolution."
                },
                {
                                "title": "Mis Palabras",
                                "footer": "My Words",
                                "type": "vocab",
                                "words": [
                                                {
                                                                "es": "almuerzo",
                                                                "en": "lunch",
                                                                "emoji": "üçΩÔ∏è"
                                                },
                                                {
                                                                "es": "s√°ndwich",
                                                                "en": "sandwich",
                                                                "emoji": "ü•™"
                                                },
                                                {
                                                                "es": "sopa",
                                                                "en": "soup",
                                                                "emoji": "üçú"
                                                },
                                                {
                                                                "es": "ensalada",
                                                                "en": "salad",
                                                                "emoji": "ü•ó"
                                                },
                                                {
                                                                "es": "arroz",
                                                                "en": "rice",
                                                                "emoji": "üçö"
                                                },
                                                {
                                                                "es": "pollo",
                                                                "en": "chicken",
                                                                "emoji": "üçó"
                                                }
                                ]
                },
                {
                                "title": "¬°Ganaste tu insignia!",
                                "footer": "You earned your badge!",
                                "type": "badge",
                                "badgeEmoji": "ü•™",
                                "badgeName": "Chef del Almuerzo",
                                "badgeNameEn": "Lunch Chef"
                }
]
        };

        const Icons = {
            ChevronLeft: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Loader: ({ size = 24, className }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Download: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Volume: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
            Play: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>,
            Stop: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2" fill="currentColor"/></svg>
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + pcmData.length, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, pcmData.length, true); new Uint8Array(buffer, 44).set(pcmData);
            return new Blob([buffer], { type: 'audio/wav' });
        };

        // Badge system ‚Äî persists across all books via localStorage
        const BADGE_KEY = 'beibei_badges';
        const getBadges = () => { try { return JSON.parse(localStorage.getItem(BADGE_KEY) || '{}'); } catch(e) { return {}; } };
        const saveBadge = (bookSlug, badge) => { const b = getBadges(); b[bookSlug] = badge; localStorage.setItem(BADGE_KEY, JSON.stringify(b)); return b; };

        const BadgePopup = ({ badges, onClose }) => {
            const badgeList = Object.values(badges);
            return (
                <div className="fixed inset-0 bg-black/60 z-[999] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-6 md:p-8 max-w-md w-full shadow-2xl text-center" onClick={e => e.stopPropagation()}>
                        <div className="text-4xl md:text-5xl mb-3">üèÜ</div>
                        <h2 className="text-2xl md:text-3xl font-black text-gray-800 mb-1">¬°Mis Insignias!</h2>
                        <p className="text-sm text-gray-500 mb-1">My Badges</p>
                        <p className="text-lg font-bold text-indigo-600 mb-4">{badgeList.length} {badgeList.length === 1 ? 'insignia' : 'insignias'} ganada{badgeList.length === 1 ? '' : 's'}</p>
                        <div className="grid grid-cols-3 gap-3 mb-5">
                            {badgeList.map((b, i) => (
                                <div key={i} className="flex flex-col items-center">
                                    <div className="w-16 h-16 md:w-20 md:h-20 rounded-full bg-gradient-to-br from-yellow-300 via-amber-400 to-orange-400 flex items-center justify-center shadow-lg border-3 border-yellow-200">
                                        <span className="text-2xl md:text-3xl">{b.emoji}</span>
                                    </div>
                                    <p className="text-[10px] md:text-xs font-bold text-gray-700 mt-1 leading-tight">{b.name}</p>
                                </div>
                            ))}
                        </div>
                        <p className="text-xs text-gray-400 mb-4">üéØ ¬°Sigue leyendo para coleccionar m√°s!</p>
                        <button onClick={onClose} className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition">¬°Genial! üéâ</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [viewMode, setViewMode] = useState('preview');
            const [currentPage, setCurrentPage] = useState(0);
            const [images, setImages] = useState({});
            const [audioCache, setAudioCache] = useState({});
            const [isReading, setIsReading] = useState(false);
            const [isAutoAdvancing, setIsAutoAdvancing] = useState(false);
            const [isAnimating, setIsAnimating] = useState(false);
            const [direction, setDirection] = useState('next');
            const [activeWordIndex, setActiveWordIndex] = useState(-1);
            const [generatingPdf, setGeneratingPdf] = useState(false);
            const [showBadgePopup, setShowBadgePopup] = useState(false);
            const [allBadges, setAllBadges] = useState(getBadges());
            const audioRef = useRef(null);
            const syncRef = useRef(null);

            // Save badge when reaching the badge page
            useEffect(() => {
                const page = BOOK_CONFIG.pages[currentPage];
                if (page && page.type === 'badge') {
                    const updated = saveBadge(BOOK_CONFIG.slug, { emoji: page.badgeEmoji, name: page.badgeName, nameEn: page.badgeNameEn });
                    setAllBadges(updated);
                    setShowBadgePopup(true);
                }
            }, [currentPage]);
            const printRef = useRef(null);
            const fetchPromisesRef = useRef({});
            const touchStartRef = useRef(null);

            // Touch swipe support for mobile/tablet
            useEffect(() => {
                const handleTouchStart = (e) => { touchStartRef.current = e.touches[0].clientX; };
                const handleTouchEnd = (e) => {
                    if (touchStartRef.current === null) return;
                    const diff = touchStartRef.current - e.changedTouches[0].clientX;
                    if (Math.abs(diff) > 50) { // minimum swipe distance
                        if (diff > 0 && currentPage < BOOK_CONFIG.pages.length - 1) nav(currentPage + 1, 'next');
                        else if (diff < 0 && currentPage > 0) nav(currentPage - 1, 'prev');
                    }
                    touchStartRef.current = null;
                };
                document.addEventListener('touchstart', handleTouchStart);
                document.addEventListener('touchend', handleTouchEnd);
                return () => {
                    document.removeEventListener('touchstart', handleTouchStart);
                    document.removeEventListener('touchend', handleTouchEnd);
                };
            }, [currentPage, isAnimating]);

            useEffect(() => {
                const loadImages = async () => {
                    // Try static pre-generated images first (instant!)
                    const staticLoads = BOOK_CONFIG.pages.map(async (_, i) => {
                        const filename = `images/page-${String(i).padStart(2, '0')}.png`;
                        try {
                            const res = await fetch(filename, { method: 'HEAD' });
                            if (res.ok) {
                                setImages(prev => ({ ...prev, [i]: filename }));
                                return true;
                            }
                        } catch(e) {}
                        return false;
                    });
                    const results = await Promise.all(staticLoads);

                    // For any missing static images, generate via API
                    const missing = results.map((ok, i) => ok ? null : i).filter(i => i !== null);
                    if (missing.length === 0) return;

                    const apiLoads = missing.filter(i => BOOK_CONFIG.pages[i].prompt).map(async (i) => {
                        const page = BOOK_CONFIG.pages[i];
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp-image-generation:generateContent?key=${apiKey}`;
                        try {
                            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Generate a high quality image: ${page.prompt}` }] }], generationConfig: { responseModalities: ['IMAGE', 'TEXT'] } }) });
                            const data = await response.json();
                            if (data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)) {
                                setImages(prev => ({ ...prev, [i]: (() => { const img = data.candidates[0].content.parts.find(p => p.inlineData); return `data:image/png;base64,${img.inlineData.data}`; })() }));
                            }
                        } catch (e) { console.error(`Image ${i} failed`, e); }
                    });
                    await Promise.all(apiLoads);
                };
                loadImages();
            }, []);

            const prefetchAudio = async (index) => {
                if (audioCache[index]) return audioCache[index];
                if (fetchPromisesRef.current[index]) return fetchPromisesRef.current[index];
                fetchPromisesRef.current[index] = (async () => {
                    const text = `${BOOK_CONFIG.pages[index].title}. ${BOOK_CONFIG.pages[index].footer}`;
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: `Read standard neutral Spanish clearly: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Leda" } } } }, model: "gemini-2.5-flash-preview-tts" })
                        });
                        const data = await response.json();
                        const inlineData = data.candidates[0].content.parts[0].inlineData;
                        const pcm = Uint8Array.from(atob(inlineData.data), c => c.charCodeAt(0));
                        const sampleRate = parseInt(inlineData.mimeType.split('rate=')[1]) || 24000;
                        const url = URL.createObjectURL(pcmToWav(pcm, sampleRate));
                        setAudioCache(prev => ({ ...prev, [index]: url }));
                        return url;
                    } catch (e) { return null; } finally { delete fetchPromisesRef.current[index]; }
                })();
                return fetchPromisesRef.current[index];
            };

            const readPage = async (auto = false, overrideIdx = null) => {
                const idx = overrideIdx !== null ? overrideIdx : currentPage;
                if (isReading && overrideIdx === null) { stopReading(); return; }
                setIsReading(true);
                if (auto) setIsAutoAdvancing(true);
                // Retry TTS up to 3 times with delay (free tier rate limit)
                let url = null;
                for (let attempt = 0; attempt < 3; attempt++) {
                    url = await prefetchAudio(idx);
                    if (url) break;
                    await new Promise(r => setTimeout(r, 3000)); // wait 3s before retry
                }
                if (!url) {
                    setIsReading(false);
                    setIsAutoAdvancing(false);
                    return;
                }
                const audio = new Audio(url);
                audio.volume = 0.8;
                audioRef.current = audio;
                const fullText = `${BOOK_CONFIG.pages[idx].title}. ${BOOK_CONFIG.pages[idx].footer}`;
                const words = fullText.replace(/\. /g, ' . ').split(/\s+/);
                audio.onplay = () => {
                    const update = () => {
                        if (audioRef.current === audio && !audio.paused && !audio.ended) {
                            const wordIdx = Math.floor((audio.currentTime / audio.duration) * words.length);
                            const currentWord = words[wordIdx];
                            if (currentWord !== '.') {
                                const activeCount = words.slice(0, wordIdx).filter(w => w !== '.').length;
                                setActiveWordIndex(activeCount);
                            }
                            syncRef.current = requestAnimationFrame(update);
                        }
                    };
                    update();
                };
                audio.onended = () => {
                    setIsReading(false); setActiveWordIndex(-1);
                    if (auto || isAutoAdvancing) {
                        if (idx < BOOK_CONFIG.pages.length - 1) { setTimeout(() => nav(idx + 1, 'next', true), 1000); }
                        else { setIsAutoAdvancing(false); }
                    }
                };
                audio.play().catch(() => setIsReading(false));
            };

            const stopReading = () => {
                if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
                setIsReading(false); setIsAutoAdvancing(false); setActiveWordIndex(-1);
                if (syncRef.current) cancelAnimationFrame(syncRef.current);
            };

            const nav = (idx, dir, fromAuto = false) => {
                if (isAnimating && !fromAuto) return;
                if (!fromAuto) stopReading();
                setDirection(dir); setIsAnimating(true);
                setTimeout(() => { setCurrentPage(idx); setIsAnimating(false);
                    // Auto-read page on any navigation (skip vocab/badge - they have own audio)
                    const pg = BOOK_CONFIG.pages[idx]; if (pg && !pg.type) setTimeout(() => readPage(fromAuto, idx), 500);
                }, 600);
            };

            const handleDownloadPdf = async () => {
                setGeneratingPdf(true); const originalMode = viewMode; setViewMode('print');
                setTimeout(async () => {
                    const element = printRef.current;
                    const opt = { margin: 0, filename: 'El_Almuerzo_Beibei.pdf', image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' },
                        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };
                    try { await html2pdf().set(opt).from(element).save(); } finally { setGeneratingPdf(false); setViewMode(originalMode); }
                }, 1000);
            };

            const HighlightedText = ({ text, start = 0 }) => {
                const words = text.split(/\s+/);
                return words.map((w, i) => (
                    <span key={i} className={`inline-block transition-all px-1 rounded ${activeWordIndex === (start + i) ? 'bg-yellow-300 scale-110' : ''}`}>{w}{' '}</span>
                ));
            };

            const PageUI = ({ idx, isPrint = false }) => {
                const data = BOOK_CONFIG.pages[idx];
                if (!data) return <div className="w-full h-full bg-white border border-gray-100" />;
                const titleCount = data.title.split(/\s+/).length;

                // Vocabulary review page
                if (data.type === 'vocab') {
                    const [activeWord, setActiveWord] = React.useState(-1);
                    const [isAutoPlaying, setIsAutoPlaying] = React.useState(false);

                    const speakWord = async (word) => {
                        try {
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contents: [{ parts: [{ text: `Read this single Spanish word slowly and clearly: ${word}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Leda" } } } }, model: "gemini-2.5-flash-preview-tts" })
                            });
                            const d = await response.json();
                            const inlineData = d.candidates[0].content.parts[0].inlineData;
                            const pcm = Uint8Array.from(atob(inlineData.data), c => c.charCodeAt(0));
                            const sampleRate = parseInt(inlineData.mimeType.split('rate=')[1]) || 24000;
                            const audio = new Audio(URL.createObjectURL(pcmToWav(pcm, sampleRate)));
                            return new Promise(resolve => { audio.onended = resolve; audio.play(); });
                        } catch(e) { console.error('TTS failed', e); }
                    };

                    const autoPlayAll = async () => {
                        if (isAutoPlaying) return;
                        setIsAutoPlaying(true);
                        for (let i = 0; i < data.words.length; i++) {
                            setActiveWord(i);
                            await speakWord(data.words[i].es);
                            await new Promise(r => setTimeout(r, 500));
                        }
                        setActiveWord(-1);
                        setIsAutoPlaying(false);
                    };

                    React.useEffect(() => { autoPlayAll(); }, []);

                    return (
                        <div className={`relative flex flex-col items-center justify-between bg-white ${isPrint ? 'w-[5.5in] h-[8.5in] p-10' : 'w-full h-full p-3 md:p-8 shadow-inner border-l-4 border-gray-100 overflow-auto'}`}>
                            <div className="text-center w-full flex-shrink-0 mb-2 md:mb-4">
                                <h2 className="text-3xl md:text-5xl font-bold text-gray-800">üìù {data.title}</h2>
                                <p className="text-base md:text-xl text-gray-500 mt-1">{data.footer}</p>
                                <p className="text-sm text-indigo-400 mt-1">üëÜ Tap a word to hear it!</p>
                            </div>
                            <div className="flex-1 w-full grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-4 content-start">
                                {data.words.map((w, i) => (
                                    <div key={i} onClick={() => speakWord(w.es).then(() => setActiveWord(-1)) || setActiveWord(i)} className={`rounded-xl p-3 md:p-5 text-center border-2 transition-all duration-300 cursor-pointer select-none ${activeWord === i ? 'bg-gradient-to-br from-yellow-100 to-amber-100 border-amber-400 scale-110 shadow-lg ring-2 ring-amber-300' : 'bg-gradient-to-br from-indigo-50 to-purple-50 border-indigo-100 hover:border-indigo-300 hover:scale-105 active:scale-95'}`}>
                                        <div className="text-3xl md:text-4xl mb-1">{w.emoji}</div>
                                        <div className={`text-lg md:text-2xl font-black ${activeWord === i ? 'text-amber-700' : 'text-indigo-700'}`}>{w.es}</div>
                                        <div className="text-sm md:text-base text-gray-500">{w.en}</div>
                                        <div className="text-xs text-indigo-300 mt-1">üîä</div>
                                    </div>
                                ))}
                            </div>
                            <div className="pt-2 md:pt-4 border-t border-gray-100 flex justify-between text-[8px] md:text-[10px] uppercase font-bold text-gray-300 w-full mt-2">
                                <span>Lectura Temprana</span><span>P√°gina {idx + 1}</span>
                            </div>
                        </div>
                    );
                }

                // Badge page
                if (data.type === 'badge') {
                    return (
                        <div className={`relative flex flex-col items-center justify-center bg-gradient-to-br from-yellow-50 via-white to-amber-50 ${isPrint ? 'w-[5.5in] h-[8.5in] p-10' : 'w-full h-full p-3 md:p-8 shadow-inner border-l-4 border-yellow-200 overflow-hidden'}`}>
                            <div className="text-center space-y-3 md:space-y-5">
                                <div className="text-4xl md:text-6xl animate-bounce">üèÜ</div>
                                <h2 className="text-2xl md:text-4xl font-black text-gray-800">{data.title}</h2>
                                <p className="text-sm md:text-lg text-gray-500">{data.footer}</p>
                                <div className="relative inline-block">
                                    <div className="w-28 h-28 md:w-40 md:h-40 rounded-full bg-gradient-to-br from-yellow-300 via-amber-400 to-orange-400 flex items-center justify-center shadow-2xl border-4 border-yellow-200 mx-auto">
                                        <span className="text-5xl md:text-7xl">{data.badgeEmoji}</span>
                                    </div>
                                    <div className="absolute -top-2 -right-2 text-2xl md:text-3xl">‚≠ê</div>
                                </div>
                                <div>
                                    <p className="text-lg md:text-2xl font-black text-amber-700 mt-2">{data.badgeName}</p>
                                    <p className="text-xs md:text-sm text-gray-500">{data.badgeNameEn}</p>
                                </div>
                                <p className="text-xs md:text-sm text-indigo-500 font-bold mt-2">üéØ ¬°Colecciona insignias para desbloquear premios!</p>
                                <p className="text-[10px] md:text-xs text-gray-400">Collect badges to unlock prizes!</p>
                                <a href="/" className="inline-block px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition shadow-lg hover:scale-105 active:scale-95 mt-2">üìö More Books</a>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className={`relative flex flex-col items-center justify-between bg-white ${isPrint ? 'w-[5.5in] h-[8.5in] p-10' : 'w-full h-full p-1 md:p-10 shadow-none md:shadow-inner border-0 md:border-l-4 border-gray-100 overflow-hidden'}`}>
                        <div className="text-center w-full flex-shrink-0">
                            <h2 className="text-4xl md:text-6xl font-bold text-gray-800 mb-1 md:mb-3 leading-tight">
                                {isPrint ? data.title : <HighlightedText text={data.title} start={0} />}
                            </h2>
                            {idx === 0 && (
                                <div className="flex items-center justify-center gap-2 mt-1">
                                    <img src={BOOK_CONFIG.logoUrl} className="h-4 md:h-6 object-contain" />
                                    <span className="text-blue-600 text-[8px] md:text-[10px] font-bold uppercase tracking-widest">{BOOK_CONFIG.schoolName}</span>
                                </div>
                            )}
                        </div>
                        <div className="flex-1 flex items-center justify-center w-full my-1 md:my-4 min-h-0">
                            {images[idx] ? (
                                <img src={images[idx]} className="max-h-[60vh] md:max-h-[70vh] max-w-full object-contain drop-shadow-xl" />
                            ) : (
                                <div className="flex flex-col items-center gap-2">
                                    <Icons.Loader size={32} className="text-blue-200" />
                                    <span className="text-[8px] uppercase tracking-tighter text-blue-300 animate-pulse">Generando...</span>
                                </div>
                            )}
                        </div>
                        <div className="w-full text-center space-y-1 md:space-y-4 flex-shrink-0">
                            <div className="flex items-center justify-center gap-3">
                                <p className="text-xl md:text-3xl font-bold text-gray-700">
                                    {isPrint ? data.footer : <HighlightedText text={data.footer} start={titleCount} />}
                                </p>
                                {!isPrint && (
                                    <button onClick={() => readPage(false)} className={`p-2 md:p-3 rounded-full shadow-lg transition flex-shrink-0 ${isReading ? 'bg-blue-100 text-blue-400' : 'bg-blue-600 text-white hover:scale-105 active:scale-95'}`}>
                                        <Icons.Volume size={18} />
                                    </button>
                                )}
                            </div>
                            <div className="pt-2 md:pt-4 border-t border-gray-100 flex justify-between text-[8px] md:text-[10px] uppercase font-bold text-gray-300">
                                <span>Lectura Temprana</span><span>P√°gina {idx + 1}</span>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col text-slate-900 overflow-hidden">
                    {showBadgePopup && <BadgePopup badges={allBadges} onClose={() => setShowBadgePopup(false)} />}
                    <header className="bg-white p-1 md:p-4 sticky top-0 z-50 flex flex-wrap justify-center items-center px-4 md:px-8 shadow-sm border-b gap-2">
                        <div className="flex items-center gap-3">
                            <img src={BOOK_CONFIG.logoUrl} className="h-8 w-8 md:h-10 md:w-10 object-contain rounded-full bg-slate-50 p-1" />
                            <div>
                                <h1 className="font-black text-lg md:text-2xl leading-none text-center">{BOOK_CONFIG.title}</h1>
                                <a href="https://www.beibeiamigos.com" target="_blank" className="text-[8px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest hover:text-indigo-500 transition">{BOOK_CONFIG.schoolName}</a>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 md:gap-4">
                            <div className="bg-slate-100 p-1 rounded-xl flex gap-1">
                                <button onClick={() => setViewMode('preview')} className={`px-4 md:px-6 py-2.5 md:py-3 rounded-xl text-sm md:text-base font-bold transition ${viewMode === 'preview' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}>Book</button>
                                <button onClick={() => setViewMode('print')} className={`px-4 md:px-6 py-2.5 md:py-3 rounded-xl text-sm md:text-base font-bold transition ${viewMode === 'print' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}>Print</button>
                            </div>
                            <button onClick={handleDownloadPdf} disabled={generatingPdf} className="flex items-center gap-2 px-5 md:px-7 py-2.5 md:py-3 bg-emerald-600 text-white rounded-xl text-sm md:text-base font-bold hover:bg-emerald-700 transition shadow-md disabled:opacity-50 hidden md:flex">
                                {generatingPdf ? <Icons.Loader size={12} /> : <Icons.Download size={12} />}
                                <span>{generatingPdf ? "Generating..." : "Download PDF"}</span>
                            </button>
                        </div>
                    </header>
                    {/* Read to Me button - between header and book */}
                    {viewMode === 'preview' && (
                        <div className="flex justify-center py-1 md:py-2">
                            <button onClick={() => readPage(true)} className={`flex items-center gap-3 px-8 md:px-10 py-3 md:py-4 rounded-2xl text-lg md:text-xl font-black transition shadow-2xl ${isAutoAdvancing ? "bg-red-500 text-white hover:bg-red-600 animate-pulse" : "bg-indigo-600 text-white hover:bg-indigo-700 hover:scale-105 active:scale-95"}`}>
                                {isAutoAdvancing ? <Icons.Stop size={24} /> : <Icons.Play size={24} />}
                                {isAutoAdvancing ? "Stop" : "üìñ Read to Me"}
                            </button>
                        </div>
                    )}
                    <main className="flex-1 flex flex-col items-center justify-start md:justify-center p-0 md:p-4 md:py-6 overflow-hidden">
                        {viewMode === 'preview' ? (
                            <div className="w-full w-full max-w-full md:max-w-5xl flex flex-col items-center gap-0 md:gap-4 h-full flex-1 max-h-[calc(100vh-56px)] md:max-h-[calc(100vh-160px)]">
                                <div className="flex items-center gap-0 md:gap-8 w-full justify-center flex-1 min-h-0 relative overflow-hidden">
                                    <button onClick={() => nav(currentPage - 1, 'prev')} disabled={currentPage === 0 || isAnimating} className="p-2 md:p-4 bg-white/80 md:bg-white rounded-full shadow-lg disabled:opacity-20 transition hover:scale-110 active:scale-90 flex-shrink-0 absolute left-1 md:relative md:left-auto z-10"><Icons.ChevronLeft size={24} /></button>
                                    <div className="perspective-2000 w-full h-full max-w-full md:max-w-5xl bg-white shadow-none md:shadow-2xl rounded-none md:rounded-2xl overflow-hidden relative border-0 md:border md:border-slate-200 flex flex-col">
                                        <div className={`w-full h-full transform-style-3d ${isAnimating ? (direction === 'next' ? 'page-flip-next' : 'page-flip-prev') : ''}`}>
                                            <PageUI idx={currentPage} />
                                        </div>
                                    </div>
                                    <button onClick={() => nav(currentPage + 1, 'next')} disabled={currentPage === BOOK_CONFIG.pages.length - 1 || isAnimating} className="p-2 md:p-4 bg-white/80 md:bg-white rounded-full shadow-lg disabled:opacity-20 transition hover:scale-110 active:scale-90 flex-shrink-0 absolute right-1 md:relative md:right-auto z-10"><Icons.ChevronRight size={24} /></button>
                                </div>
                                <div className="flex gap-2 flex-shrink-0 hidden md:flex">
                                    {BOOK_CONFIG.pages.map((_, i) => (<div key={i} className={`h-1.5 md:h-2.5 rounded-full transition-all duration-300 ${i === currentPage ? "bg-indigo-500 w-6 md:w-8" : "bg-slate-200 w-1.5 md:w-2.5"}`} />))}
                                </div>
                            </div>
                        ) : (
                            <div ref={printRef} className="flex flex-col items-center gap-12 bg-slate-200 p-6 md:p-12 rounded-3xl shadow-inner border border-slate-300 overflow-y-auto max-h-full">
                                {[[7,0],[1,6],[5,2],[3,4]].map(([leftIdx, rightIdx], spreadIdx) => (
                                    <div key={spreadIdx} className="flex bg-white shadow-2xl rounded-sm overflow-hidden pdf-page flex-shrink-0" style={{ width: '11in', height: '8.5in' }}>
                                        <PageUI idx={leftIdx} isPrint /><div className="w-px bg-slate-100 h-full relative"><div className="absolute top-0 bottom-0 left-[-1px] right-[-1px] border-l border-dashed border-slate-200" /></div><PageUI idx={rightIdx} isPrint />
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                    {/* Upsell Section - hidden on mobile unless last page */}
                    <div className={`bg-gradient-to-r from-indigo-50 to-purple-50 border-t border-indigo-100 px-4 md:px-8 py-3 md:py-10 ${currentPage < BOOK_CONFIG.pages.length - 1 ? "hidden md:block" : ""}`}>
                      <div className="max-w-full md:max-w-4xl mx-auto px-2 md:px-0">
                        <h3 className="text-lg md:text-2xl font-bold text-center text-gray-800 mb-6">¬øTe gust√≥ este libro? ¬°Hay m√°s!</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                          <a href="/" className="bg-white rounded-xl p-5 shadow-md hover:shadow-lg transition text-center no-underline">
                            <div className="text-3xl mb-2">üìö</div>
                            <div className="font-bold text-gray-800 text-sm">More Free Books</div>
                            <div className="text-xs text-gray-500 mt-1">52 weeks of Spanish reading adventures</div>
                          </a>
                          <a href="https://tutti-sophia.onrender.com/sofia-fullscreen.html" target="_blank" className="bg-white rounded-xl p-5 shadow-md hover:shadow-lg transition text-center no-underline border-2 border-indigo-200">
                            <div className="text-3xl mb-2">üë©‚Äçüè´</div>
                            <div className="font-bold text-indigo-600 text-sm">Meet Sofia ‚Äî AI Spanish Teacher</div>
                            <div className="text-xs text-gray-500 mt-1">Your child speaks with a real AI tutor!</div>
                          </a>
                          <a href="https://www.beibeiamigos.com" target="_blank" className="bg-white rounded-xl p-5 shadow-md hover:shadow-lg transition text-center no-underline">
                            <div className="text-3xl mb-2">üè´</div>
                            <div className="font-bold text-gray-800 text-sm">Beibei Amigos Preschool</div>
                            <div className="text-xs text-gray-500 mt-1">Trilingual immersion in Phoenix, AZ</div>
                          </a>
                        </div>
                        <div className="mt-6 text-center">
                          <p className="text-xs text-gray-400">Share this book with other parents!</p>
                          <div className="flex justify-center gap-3 mt-2">
                            <a href="https://www.facebook.com/sharer/sharer.php?u=https://spanish-books.onrender.com/books/week-10-el-almuerzo/" target="_blank" className="text-blue-600 text-sm font-bold hover:underline">Facebook</a>
                            <span className="text-gray-300">‚Ä¢</span>
                            <a href="https://wa.me/?text=Check%20out%20this%20free%20Spanish%20book%20for%20kids!%20https://spanish-books.onrender.com/books/week-10-el-almuerzo/" target="_blank" className="text-green-600 text-sm font-bold hover:underline">WhatsApp</a>
                            <span className="text-gray-300">‚Ä¢</span>
                            <a href="mailto:?subject=Free Spanish Book for Kids&body=Check out this interactive Spanish book for preschoolers: https://spanish-books.onrender.com/books/week-10-el-almuerzo/" className="text-gray-600 text-sm font-bold hover:underline">Email</a>
                          </div>
                        </div>
                      </div>
                    </div>
                    <footer className="py-4 text-center flex-shrink-0 hidden md:block">
                      <a href="https://www.beibeiamigos.com" target="_blank" className="text-slate-400 text-[8px] md:text-[10px] font-bold uppercase tracking-[0.2em] hover:text-indigo-500 transition">&copy; 2025 Beibei Amigos Language Preschool ‚Äî Visit Our School ‚Üícopy; 2026 Beibei Amigos Language Preschool ‚Äî Spanish Immersion ¬∑ Mandarin Preschool ¬∑ Bilingual Books ‚Äî Visit Our School ‚Üí</a>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
